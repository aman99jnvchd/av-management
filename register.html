<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - AV Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div class="ls-page-wrapper">
        <div class="ls-dual-container">
            <!-- Left Column - Logo & Text Section -->
            <div class="ls-visual-section">
                <div class="ls-visual-bg-animation"></div>
                <div class="ls-floating-elements">
                    <div class="ls-floating-shape"></div>
                    <div class="ls-floating-shape"></div>
                    <div class="ls-floating-shape"></div>
                </div>
                <div class="ls-logo-wrapper">
                    <div class="ls-company-logo">
                       <img src="assets/img/logo.png" width="220" alt="">
                    </div>
                </div>
                <div class="ls-brand-content">
                    <!-- <h2 class="ls-brand-title">MANAGEMENT SOLUTION</h2> -->
                    <p class="ls-brand-description">Streamline your business operations with our comprehensive legal and financial management platform. Trusted by thousands of professionals worldwide.</p>
                    <ul class="ls-feature-list">
                        <li class="ls-feature-item">
                            <i class="bi bi-check-circle-fill ls-feature-icon"></i>
                            Secure & Reliable
                        </li>
                        <li class="ls-feature-item">
                            <i class="bi bi-check-circle-fill ls-feature-icon"></i>
                            Easy to Use Interface
                        </li>
                        <li class="ls-feature-item">
                            <i class="bi bi-check-circle-fill ls-feature-icon"></i>
                            24/7 Customer Support
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Right Column - Login Form Section -->
            <div class="ls-content-section">
                <div class="ls-form-header">
                    <div class="ls-section-badge">
                        <i class="bi bi-shield-check"></i>
                        Secure Register
                    </div>
                    <h2 class="ls-section-title">Register Here</h2>
                    <p class="ls-section-description">Enter your details to create your account</p>
                </div>

                <form class="ls-login-form" id="loginForm">
                    <div class="ls-input-wrapper">
                        <label for="name" class="ls-input-label">Name</label>
                        <div style="position: relative;">
                            <input type="text" id="name" class="ls-input-field" placeholder="Your name" required>
                            <i class="bi bi-person-fill ls-input-icon"></i>
                        </div>
                        <div id="nameErr" class="form-error" style="display: none;"></div>
                    </div>

                    <div class="ls-input-wrapper">
                        <label for="email" class="ls-input-label">Email</label>
                        <div style="position: relative;">
                            <input type="email" id="email" class="ls-input-field" placeholder="your@email.com" required>
                            <i class="bi bi-envelope-fill ls-input-icon"></i>
                        </div>
                        <div id="emailErr" class="form-error" style="display: none;"></div>
                    </div>
                    
                    <div class="ls-input-wrapper">
                        <label for="phoneNo" class="ls-input-label">Phone No.</label>
                        <div style="position: relative;">
                            <input type="number" id="phoneNo" class="ls-input-field" placeholder="Your Phone No." required maxlength="10" />
                            <i class="bi bi-telephone-fill ls-input-icon"></i>
                        </div>
                        <div id="phoneNoErr" class="form-error" style="display: none;"></div>
                    </div>

                    <div class="ls-input-wrapper">
                        <label for="password" class="ls-input-label">Password</label>
                        <div style="position: relative;">
                            <input type="password" id="password" class="ls-input-field" placeholder="Password" required>
                            <button type="button" class="ls-password-toggle" data-target="password">
                                <i class="bi bi-eye-fill"></i>
                            </button>
                        </div>
                        <div id="passwordErr" class="form-error">
                            <span style="color: #2c3e50;">
                                Password must be at least 8 characters, with uppercase, lowercase, a number, and a special character.
                            </span>
                        </div>
                    </div>

                    <div class="ls-input-wrapper">
                        <label for="confirmPassword" class="ls-input-label">Confirm Password</label>
                        <div style="position: relative;">
                            <input type="password" id="confirmPassword" class="ls-input-field" placeholder="Confirm password" required>
                            <button type="button" class="ls-password-toggle" data-target="confirmPassword">
                                <i class="bi bi-eye-fill"></i>
                            </button>
                        </div>
                        <div id="confirmPasswordErr" class="form-error" style="display: none;"></div>
                    </div>

                    <div class="ls-form-options">
                        <a href="/forgot-password.html" class="ls-forgot-link">Forgot Password?</a>
                    </div>
                    
                    <!-- Form error to show -->
                    <div id="formError" style="display: none;">
                    </div>

                    <!-- Submit button -->
                    <button type="submit" class="ls-submit-button" id="loginBtn">
                        Register
                    </button>
                </form>

                <div class="ls-form-footer">
                    Already have an account? <a href="/login.html" class="ls-footer-link">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/api.js"></script>
    <script>
        // Check if 'accessToken' exists in localStorage and 'userData' exists in sessionStorage
        const accessToken = localStorage.getItem('accessToken');
        // const userData = sessionStorage.getItem('userData');
        const userData = localStorage.getItem('userData');

        // If both exists, redirect to dashboard page
        if (accessToken && userData) {
            window.location.href = '/admin';
        }

        const nameElement = document.getElementById("name");
        const emailElement = document.getElementById("email");
        const phoneNoElement = document.getElementById("phoneNo");
        const passwordElement = document.getElementById("password");
        const confirmPasswordElement = document.getElementById("confirmPassword");

        const nameErr = document.getElementById("nameErr");
        const emailErr = document.getElementById("emailErr");
        const phoneNoErr = document.getElementById("phoneNoErr");
        const passwordErr = document.getElementById("passwordErr");
        const confirmPasswordErr = document.getElementById("confirmPasswordErr");

        const formError = document.getElementById("formError");

        // Register user
        document.getElementById("loginForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            nameErr.style.display = "none";
            emailErr.style.display = "none";
            phoneNoErr.style.display = "none";
            confirmPasswordErr.style.display = "none";
            passwordErr.innerHTML = `<span style="color: #2c3e50;">
                Password must be at least 8 characters, with uppercase, lowercase, a number, and a special character.
            </span>`;

            formError.style.display = 'none';

            // List of required fields
            const requiredFields = [
                { id: "name", err: "nameErr", msg: "Name is required" },
                { id: "email", err: "emailErr", msg: "Email is required" },
                { id: "phoneNo", err: "phoneNoErr", msg: "Phone No. is required" },
                { id: "password", err: "passwordErr", msg: "Password is required" },
                { id: "confirmPassword", err: "confirmPasswordErr", msg: "Confirm Password is required" },
            ];

            // Validate all fields
            if (!validateRequiredFields(requiredFields)) {
                return;
            }

            const name = nameElement.value.trim();
            const email = emailElement.value.trim();
            const phoneNo = phoneNoElement.value.trim();
            const password = passwordElement.value.trim();
            const confirmPassword = confirmPasswordElement.value.trim();

            // Name must have only letters and at least 2 letters
            if (!validateName(name)) {
                nameErr.innerHTML = '<span>Please provide a valid Name</span>';
                nameErr.style.display = "block";
                return;
            }

            if (!validateEmail(email)) {
                emailErr.innerHTML = '<span>Please provide a valid Email</span>';
                emailErr.style.display = "block";
                return;
            }

            // Phone No must have 10 digits
            if (!validatePhone(phoneNo)) {
                phoneNoErr.innerHTML = '<span>Please provide a valid 10-digit phone number</span>';
                phoneNoErr.style.display = "block";
                return;
            }
                        
            // new password validation
            if (!isValidPassword(password)) {
                passwordErr.innerHTML = `<span>
                    Password must be at least 8 characters, with uppercase, lowercase, a number, and a special character.
                </span>`;
                return;
            }

            // passwords match validation
            if (password !== confirmPassword) {
                confirmPasswordErr.innerHTML = `<span>
                    Passwords do not match!
                </span>`;
                confirmPasswordErr.style.display = "block";
                return;
            }
            
            setLoading(true);

            try {
                const result = await registerUser({ 
                    "name": name,
                    "email": email,
                    "phone_no": phoneNo,
                    "password": password,
                    "confirm_password": confirmPassword,
                });

                console.log(result);
                if (result == "API failed") {
                    formError.innerHTML = `<span>Something went wrong. Please try again.</span>`;
                    formError.style.display = 'flex';

                    setLoading(false);
                    throw new Error(result);
                }

                if (result.status !== 200) {
                    if(result.error.email) {
                        formError.innerHTML = `<span>${result.error.email}</span>`;
                        formError.style.display = 'flex';
                    } else {
                        formError.innerHTML = `<span>${result.message}</span>`;
                        formError.style.display = 'flex';
                    }
                    
                    setLoading(false);
                    return;
                }

                formError.innerHTML = `<span style="color: green;">${result.message}</span>`;
                formError.style.display = 'flex';
            } catch (error) {
                console.error("Register user error:", error);

                formError.innerHTML = `<span>Something went wrong. Please try again.</span>`;
                formError.style.display = 'flex';
            }

            setLoading(false);
        });

        // Password Show/Hide Toggle
        document.querySelectorAll(".ls-password-toggle").forEach(btn => {
            btn.addEventListener("click", () => {
                const inputId = btn.getAttribute("data-target");
                const input = document.getElementById(inputId);
                const icon = btn.querySelector("i");

                const isPassword = input.type === "password";
                input.type = isPassword ? "text" : "password";

                icon.classList.toggle("bi-eye-fill");
                icon.classList.toggle("bi-eye-slash-fill");
            });
        });

        // set loader on form submit
        function setLoading(isLoading) {
            const loginBtn = document.getElementById('loginBtn');

            if (isLoading) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = `
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Registering...
                `;
            } else {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Register';
            }
        }

        // Email validation
        function validateEmail(email) {
            const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return regex.test(email);
        }

        // Phone No. validation
        function validatePhone(number) {
            const regex = /^[0-9]{10}$/;
            return regex.test(number);
        }

        // Name validation
        function validateName(name) {
            const regex = /^[A-Za-z ]{2,}$/;
            return regex.test(name.trim());
        }
        
        // validation
        function validateRequiredFields(fields) {
            let isValid = true;

            fields.forEach(f => {
                const input = document.getElementById(f.id);
                const error = document.getElementById(f.err);
                
                if (!input.value.trim()) {
                    error.innerHTML = `<span>${f.msg}</span>`;
                    error.style.display = "block";
                    isValid = false;
                } else {
                    if (f.err == "passwordErr") {
                        passwordErr.innerHTML = `<span style="color: #2c3e50;">
                            Password must be at least 8 characters, with uppercase, lowercase, a number, and a special character.
                        </span>`;
                    } else {
                        error.style.display = "none";
                    }
                }
            });

            return isValid;
        }

        // validate password
        function isValidPassword(password) {
            const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>])[A-Za-z\d!@#$%^&*(),.?":{}|<>]{8,}$/;
            return regex.test(password);
        }
    </script>
</body>
</html>
