<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot password - AV Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div class="ls-page-wrapper">
        <div class="ls-dual-container">
            <!-- Left Column - Logo & Text Section -->
            <div class="ls-visual-section">
                <div class="ls-visual-bg-animation"></div>
                <div class="ls-floating-elements">
                    <div class="ls-floating-shape"></div>
                    <div class="ls-floating-shape"></div>
                    <div class="ls-floating-shape"></div>
                </div>
                <div class="ls-logo-wrapper">
                    <div class="ls-company-logo">
                       <img src="assets/img/logo.png" width="220" alt="">
                    </div>
                </div>
                <div class="ls-brand-content">
                    <!-- <h2 class="ls-brand-title">MANAGEMENT SOLUTION</h2> -->
                    <p class="ls-brand-description">Streamline your business operations with our comprehensive legal and financial management platform. Trusted by thousands of professionals worldwide.</p>
                    <ul class="ls-feature-list">
                        <li class="ls-feature-item">
                            <i class="bi bi-check-circle-fill ls-feature-icon"></i>
                            Secure & Reliable
                        </li>
                        <li class="ls-feature-item">
                            <i class="bi bi-check-circle-fill ls-feature-icon"></i>
                            Easy to Use Interface
                        </li>
                        <li class="ls-feature-item">
                            <i class="bi bi-check-circle-fill ls-feature-icon"></i>
                            24/7 Customer Support
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Right Column - Login Form Section -->
            <div class="ls-content-section">
                <div class="ls-form-header">
                    <div class="ls-section-badge">
                        <i class="bi bi-shield-check"></i>
                        Secure
                    </div>
                    <h2 class="ls-section-title">Forgot your password?</h2>
                </div>

                <form class="ls-login-form" id="loginForm">
                    <div class="ls-input-wrapper">
                        <label for="email" class="ls-input-label">Enter your email and weâ€™ll send you a OTP</label>
                        <div style="position: relative;">
                            <input type="email" id="email" class="ls-input-field" placeholder="your@email.com" required>
                            <i class="bi bi-envelope-fill ls-input-icon"></i>
                        </div>
                        <div class="send-otp">
                            <span id="sendOTP">Send OTP</span>
                        </div>
                        <div id="emailErr" class="form-error" style="display: none;"></div>
                    </div>

                    <div class="ls-input-wrapper">
                        <label for="password" class="ls-input-label">New Password</label>
                        <div style="position: relative;">
                            <input type="password" id="password" class="ls-input-field" placeholder="New password" required>
                            <button type="button" class="ls-password-toggle" >
                                <i class="bi bi-eye-fill" id="toggleIcon"></i>
                            </button>
                        </div>
                        <div id="passwordErr" class="form-error">
                            <span style="color: #2c3e50;">
                                Password must be at least 8 characters, with uppercase, lowercase, a number, and a special character.
                            </span>
                        </div>
                    </div>
                    
                    <div class="ls-input-wrapper">
                        <label for="confirmPassword" class="ls-input-label">Confirm Password</label>
                        <div style="position: relative;">
                            <input type="password" id="confirmPassword" class="ls-input-field" placeholder="Confirm password" required>
                            <button type="button" class="ls-password-toggle" id="cnfrmToggleBtn">
                                <i class="bi bi-eye-fill" id="cnfrmToggleIcon"></i>
                            </button>
                        </div>
                        <div id="confirmPasswordErr" class="form-error" style="display: none;"></div>
                    </div>
                    
                    <div class="ls-input-wrapper">
                        <label for="otp" class="ls-input-label">OTP</label>
                        <div style="position: relative;">
                            <input type="password" id="otp" class="ls-input-field" placeholder="****" required maxlength="4" autocomplete="off" />
                        </div>
                        <div id="otpErr" class="form-error" style="display: none;"></div>
                    </div>

                    <div class="ls-form-options">
                        <a href="/login.html" class="ls-forgot-link back">
                            <i class="bi bi-arrow-left"></i>
                            Back to login
                        </a>
                    </div>
                    
                    <!-- Form error to show -->
                    <div id="formError" style="display: none;">
                    </div>

                    <!-- Submit button -->
                    <button type="submit" class="ls-submit-button" id="loginBtn">
                        Update Password
                    </button>
                </form>

                <div class="ls-form-footer">
                    Don't have an account? <a href="/register.html" class="ls-footer-link">Sign Up</a>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/api.js"></script>
    <script>
        redirectIfLoggedIn();

        const emailElement = document.getElementById("email");
        const passwordElement = document.getElementById("password");
        const confirmPasswordElement = document.getElementById("confirmPassword");
        const otpElement = document.getElementById("otp");

        const emailErr = document.getElementById("emailErr");
        const passwordErr = document.getElementById("passwordErr");
        const confirmPasswordErr = document.getElementById("confirmPasswordErr");
        const otpErr = document.getElementById("otpErr");
        
        // send OTP
        document.getElementById("sendOTP").addEventListener("click", async function() {
            const email = emailElement.value.trim();

            emailErr.style.display = "none";

            if (!email) {
                emailErr.innerHTML = '<span>Email is required</span>';
                emailErr.style.display = "block";
                return;
            }

            if (!validateEmail(email)) {
                emailErr.innerHTML = '<span>Please provide a valid Email</span>';
                emailErr.style.display = "block";
                return;
            }

            sendOTPLoading(true);

            try {
                const result = await forgetPassword({ 
                    "email": email,
                });

                console.log(result);
                if (result == "API failed") {
                    emailErr.innerHTML = `<span>Something went wrong. Please try again.</span>`;
                    emailErr.style.display = 'block';

                    sendOTPLoading(false);
                    throw new Error(result);
                }

                if (result.status !== 200) {
                    emailErr.innerHTML = `<span>${result.message}</span>`;
                    emailErr.style.display = 'block';
                    sendOTPLoading(false);
                    return;
                }

                emailErr.innerHTML = `<span style="color: green;">${result.message}</span>`;
                emailErr.style.display = 'block';
                sendOTPLoading(false);
                startOTPTimer();
            } catch (error) {
                console.error("Forgot password error:", error);
                emailErr.innerHTML = `<span>Something went wrong. Please try again.</span>`;
                emailErr.style.display = 'block';
            }
            sendOTPLoading(false);
        })

        const sendOTPBtn = document.getElementById('sendOTP');
        // set loader on OTP sent
        function sendOTPLoading(isLoading) {
            if (isLoading) {
                sendOTPBtn.style.pointerEvents = 'none';
                sendOTPBtn.innerHTML = 'Sending...';
            } else {
                sendOTPBtn.style.pointerEvents = 'auto';
                sendOTPBtn.innerHTML = 'Send OTP';
            }
        }

        let otpTimer;
        function startOTPTimer() {
            let timeLeft = 60;
            
            otpTimer = setInterval(() => {
                sendOTPBtn.style.pointerEvents = "none";
                sendOTPBtn.innerHTML = `Resend OTP in ${timeLeft} sec`;
                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(otpTimer);
                    sendOTPBtn.innerHTML = "Send OTP";
                    sendOTPBtn.style.pointerEvents = "auto";
                }
            }, 1000);
        }

        const formError = document.getElementById("formError");
        // Change password via forgot passsword 
        document.getElementById("loginForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            emailErr.style.display = "none";
            confirmPasswordErr.style.display = "none";
            otpErr.style.display = "none";
            passwordErr.innerHTML = `<span style="color: #2c3e50;">
                Password must be at least 8 characters, with uppercase, lowercase, a number, and a special character.
            </span>`;


            formError.style.display = 'none';

            // List of required fields
            const requiredFields = [
                { id: "email", err: "emailErr", msg: "Email is required" },
                { id: "password", err: "passwordErr", msg: "New Password is required" },
                { id: "confirmPassword", err: "confirmPasswordErr", msg: "Confirm Password is required" },
                { id: "otp", err: "otpErr", msg: "OTP is required" },
            ];

            // Validate all fields
            if (!validateRequiredFields(requiredFields)) {
                return;
            }

            const email = emailElement.value.trim();
            const password = passwordElement.value.trim();
            const confirmPassword = confirmPasswordElement.value.trim();
            const otp = otpElement.value.trim();

            if (!validateEmail(email)) {
                emailErr.innerHTML = '<span>Please provide a valid Email</span>';
                emailErr.style.display = "block";
                return;
            }
                        
            // new password validation
            if (!isValidPassword(password)) {
                passwordErr.innerHTML = `<span>
                    Password must be at least 8 characters, with uppercase, lowercase, a number, and a special character.
                </span>`;
                return;
            }

            // passwords match validation
            if (password !== confirmPassword) {
                confirmPasswordErr.innerHTML = `<span>
                    Passwords do not match!
                </span>`;
                confirmPasswordErr.style.display = "block";
                return;
            }
            
            setLoading(true);

            try {
                const result = await updateForgetPassword({ 
                    "email": email,
                    "password": password,
                    "confirm_password": confirmPassword,
                    "otp": otp
                });

                console.log(result);
                if (result == "API failed") {
                    formError.innerHTML = `<span>Something went wrong. Please try again.</span>`;
                    formError.style.display = 'flex';

                    setLoading(false);
                    throw new Error(result);
                }

                if (result.status !== 200) {
                    formError.innerHTML = `<span>${result.message}</span>`;
                    formError.style.display = 'flex';
                    setLoading(false);
                    return;
                }

                formError.innerHTML = `<span style="color: green;">${result.message}</span>`;
                formError.style.display = 'flex';
            } catch (error) {
                console.error("Forgot password error:", error);

                formError.innerHTML = `<span>Something went wrong. Please try again.</span>`;
                formError.style.display = 'flex';
            }

            setLoading(false);
        });

        // Password Show/Hide Toggle
        const toggleBtn = document.querySelector(".ls-password-toggle");
        const toggleIcon = document.getElementById("toggleIcon");
        toggleBtn.addEventListener("click", () => {
            const isPassword = passwordElement.type === "password";
            passwordElement.type = isPassword ? "text" : "password";
            toggleIcon.classList.toggle("bi-eye-fill");
            toggleIcon.classList.toggle("bi-eye-slash-fill");
        });

        // Confirm Password Show/Hide Toggle
        const cnfrmToggleBtn = document.getElementById("cnfrmToggleBtn");
        const cnfrmToggleIcon = document.getElementById("cnfrmToggleIcon");
        cnfrmToggleBtn.addEventListener("click", () => {
            const isPassword = confirmPassword.type === "password";
            confirmPassword.type = isPassword ? "text" : "password";
            cnfrmToggleIcon.classList.toggle("bi-eye-fill");
            cnfrmToggleIcon.classList.toggle("bi-eye-slash-fill");
        });

        // set loader on form submit
        function setLoading(isLoading) {
            const loginBtn = document.getElementById('loginBtn');

            if (isLoading) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = `
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Updating...
                `;
            } else {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Update Password';
            }
        }

        // Email validation
        function validateEmail(email) {
            const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return regex.test(email);
        }

        // validation
        function validateRequiredFields(fields) {
            let isValid = true;

            fields.forEach(f => {
                const input = document.getElementById(f.id);
                const error = document.getElementById(f.err);
                
                if (!input.value.trim()) {
                    error.innerHTML = `<span>${f.msg}</span>`;
                    error.style.display = "block";
                    isValid = false;
                } else {
                    if (f.err == "passwordErr") {
                        passwordErr.innerHTML = `<span style="color: #2c3e50;">
                            Password must be at least 8 characters, with uppercase, lowercase, a number, and a special character.
                        </span>`;
                    } else {
                        error.style.display = "none";
                    }
                }
            });

            return isValid;
        }

        // validate password
        function isValidPassword(password) {
            const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>])[A-Za-z\d!@#$%^&*(),.?":{}|<>]{8,}$/;
            return regex.test(password);
        }

        // OTP - only numbers
        document.getElementById('otp').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
